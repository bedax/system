#!/bin/sh

if [ -z "$CC" ]; then
	CC="cc -std=c89"
fi

if [ -z "$CFLAGS" ]; then
	CFLAGS="-Wall -Wextra -Wconversion -pedantic"
fi

OUT="$(mktemp)"
EXTRA_CFLAGS="-fdiagnostics-color=always $EXTRA_CFLAGS"

clear
echo "Compiling with: $CC $CFLAGS $EXTRA_CFLAGS -o $OUT $1"
OUTPUT=$($CC $CFLAGS $EXTRA_CFLAGS -o "$OUT" "$1" 2>&1)
ret=$?

if [ -n "$OUTPUT" ]; then
	echo "$OUTPUT" | less --RAW-CONTROL-CHARS --quit-if-one-screen --no-init
fi

if [ $ret -eq 0 ]; then
	shift
	echo "Running with: $OUT $@"
	echo "---"
	chmod +x "$OUT"
	"$OUT" "$@"
fi

rm -f "$OUT"
