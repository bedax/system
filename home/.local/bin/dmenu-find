#!/usr/bin/env python3

import os
import subprocess
import sys



def receive_path():
   fd_command = [
      "fdfind",
      ".",
      os.environ["HOME"],
      "--follow",
      "--hidden",
      "--no-ignore",
      "--ignore-file",
      os.path.join(os.environ["HOME"], ".ignore")
   ]

   fd = subprocess.Popen(
      fd_command,
      stdout=subprocess.PIPE
   )

   dmenu = subprocess.run(
      ["dmenu", "-i"],
      stdin=fd.stdout,
      stdout=subprocess.PIPE,
      check=False
   )

   if dmenu.returncode != 0:
      sys.exit(dmenu.returncode)
   else:
      return dmenu.stdout.decode("utf-8").strip()


def receive_command():
   dmenu_path = subprocess.Popen(
      "dmenu_path",
      stdout=subprocess.PIPE
   )

   dmenu = subprocess.run(
      "dmenu",
      stdin=dmenu_path.stdout,
      stdout=subprocess.PIPE,
      check=False
   )

   if dmenu.returncode != 0:
      sys.exit(dmenu.returncode)
   else:
      return dmenu.stdout.decode("utf-8").strip()


def run_command(command, path):
   subprocess.run(
      [command, path],
      check=False
   )


def main():
   path = receive_path()
   command = receive_command()
   run_command(command, path)



if __name__ == "__main__":
   main()
